uuid: 992cedb4-e1de-49d5-8292-89f364efa096
key: trade-lifecycle
name: Trade Lifecycle
content: Explains Trade Lifecycle on Serum DEX
guideType: onboarding
created: "2022-08-21T04:15:13.911Z"
categories:
  - developer
  - engineering
thumbnail: https://d31h13bdjwgzxs.cloudfront.net/guides/eth/aave/AAVE_Portals.png
publishStatus: Live
socialShareImage:
showIncorrectOnCompletion: true
steps:
  - uuid: 628e184c-5fe6-49d1-b6a5-4add0747a3f1
    name: Introduction
    content: |
      ## Introduction:
      The Serum DEX is a program on the Solana blockchain. Solana has block times of 400ms, and can currently process roughly 50,000 transactions per second.
      This allows Serum to handle hundreds of orders per second per market.
      Tokens on Solana are instrumented as instances of the SPL Token Program. An Solana Program Library (SPL) token on Solana is analogous to an ERC20 token on Ethereum.
      Now, before going to Trade Lifecycle, let's first understand some terminologies related to accounts specifically global accounts:
        * **Request Queue**: This account maintains all submitted but unprocessed order placement and cancellation requests.
        * **Orderbook**: Speaks for itself. There's one account for bids and another for asks, but for simplicity,
        we'll refer to both of them collectively as Orderbook going forward.
        * **Event Queue**: Reports the list of outputs from order matching: trades, for instance
        * **Market**: Holds metadata about the market (e.g. important constants like tick size and references to the other accounts below)
        * **Base Currency Vault**: An SPL token account that holds base currency balances
        * **Quote Currency Vault**: An SPL token account that holds quote currency balances

      And the user-specific accounts: to interact with the DEX, a given user must create an **OpenOrders account**. This account stores the following:
        * How much of the base and quote currency the user has locked in open orders or settleable
        * A list of open orders for that user on that market

    stepItems: []
  - uuid: 5654f373-9755-47ab-bcd5-295037ba2871
    name: Evaluation
    content: |
    stepItems:
      - uuid: 0a819f87-8f52-4436-9bff-bd380410ecd9
        content: What is the block time of Solana?
        answerKeys:
          - C
        type: SingleChoice
        choices:
          - content: 4ms
            key: A
          - content: 40ms
            key: B
          - content: 400ms
            key: C
          - content: 4000ms
            key: D

      - uuid: 8d10ae65-4897-4f65-97d8-c32826c33b9f
        content: Which of the following maintains all submitted but unprocessed order placement and cancellation requests?
        answerKeys:
          - B
        type: SingleChoice
        choices:
          - content: Event Queue
            key: A
          - content: Request Queue
            key: B
          - content: Base Currency Vault
            key: C
          - content: Orderbook
            key: D
      
      - uuid: 91f9ae5b-a46a-40b9-a8f6-b8eb0b6105bc
        content: What is the full name of SPL token?
        answerKeys:
          - D
        type: SingleChoice
        choices:
          - content: Serum Program Liquidity token
            key: A
          - content: Solana Program Liquidity token
            key: B
          - content: Serum Program Library token
            key: C
          - content: Solana Program Library token
            key: D

  - uuid: 7435646e-206d-4b76-b402-628746f9f160
    name: Trade Lifecycle - Placing Orders
    content: |
      The trade lifecycle generally consists of four main stages: placing orders, matching orders, consuming events, and settlement.
      Let's see each in detail:
      
      ## 1. Placing orders:
      A user funds an intermediary account (their OpenOrders account) from their SPL token account (wallet) and adds an order placement request to the Request Queue.
      ### Necessary steps required in placing successful orders:
        * 1. A user submits a **Place Order** instruction to the DEX program, passing:
          * Order details: the market size, price, order type, side
          * Their OpenOrders account on that market
          * Their SPL token account for the market's base currency (if selling) or quote currency (if buying)
        * 2. The **DEX program** then:
          -Transfers funds:
            * Determines the max funds required for this order (the size if selling, or size * price if buying)
            * Notes the free balance for the corresponding currency indicated in the OpenOrders account
            * Transfers the difference between the required amount and free OpenOrders balance from the SPL token account to the Base Currency Vault or Quote Currency Vault.
            * Increments the OpenOrders account's total balance for the corresponding currency by the amount transferred
          - Increments and retrieves a sequence number from the Request Queue: this, along with the order's price, determines the new order's ID.
          - Adds an item to the Request Queue specifying the order details (size, price, order type, side)
          - Adds an item representing the new order to an array in the OpenOrders account in an available slot
    
    stepItems: []
  - uuid: 6c5397e0-169a-4a28-b077-aa4739b662e9
    name: Evaluation
    content: |
    stepItems: 
      - uuid: 2fb87226-070d-40c0-94b8-54a4f18f0d94
        content: Which of the following details in not included in an order placement request?
        answerKeys:
          - B
        type: SingleChoice
        choices:
          - content: User's OpenOrders account on the market
            key: A
          - content: User's bank account for the market
            key: B
          - content: User's SPL token account for the market
            key: C
          - content: The market size, price, order type
            key: D

      - uuid: 5ef22568-2fc3-450d-94e2-2fad26cada2e
        content: Where does an order placement request gets added?
        answerKeys:
          - A
        type: SingleChoice
        choices:
          - content: To the Request Queue
            key: A
          - content: To the Event Queue
            key: B
          - content: Both A & B
            key: C
          - content: None of these
            key: D

  - uuid: 0a13a877-4d98-4d84-9667-482117c97ec3
    name: Trade Lifecycle - Matching Orders
    content: |
      ## 2. Matching orders:
        * The request is popped off the Request Queue and processed, and then placed on the Orderbook. Any resulting trades get reported in the Event Queue.
        * In a Match Orders transaction, clients (or crank turners: who perform the order matching process) provide a limit parameter,
        which specifies the number of requests to process from the Request Queue.
        -Each request is processed as follows:
          * It is popped off of the RequestQueue account
          * The corresponding cancellation or order placement is made on the Orderbook (the order book consists of one tree per side, and 
          so finding the relevant part of the appropriate tree is made easier by the comparison property of Order IDs mentioned earlier)
          * In the case of a new order that stays on the book, the Orderbook stores details about it, including the obvious specs (side, price, remaining size),
          the public key of the order placer's OpenOrders account, and the index of this order in that OpenOrders account's order array (the slot number).
          * Order types like IOC and post-only are enforced
          * For any trades, two corresponding Fill items are added to the Event Queue
          * In the case of a trade, cancel, or IOC order that is missed, Out items, are added to the Event Queue
        - The two types of event queue objects store the following information, which will be useful for the Consume Events step:
          - Fill:
            * Side
            * If this side of the trade was the maker
            * The quantity paid by this counterparty (the currency is inferable from the Side: if buying, this quantity is always denominated in the quote currency)
            * Quantity received by this counterparty (if buying, this quantity is always denominated in the base currency)
            * Quantity of any fees paid (always in the quote currency)
          - Out:
            * Side
            * Quantity unlocked
            * Quantity still locked in the order (0 in the case of cancel or full fill, nonzero in the case of partial fill)
        - And they both also store: the order's ID and slot number, the public key of the corresponding OpenOrders account
    stepItems: []
  - uuid: b9dd2c8c-f17b-4dea-abf0-e69f266aa761
    name: Evaluation
    content: |
    stepItems:
      - uuid: 0055bc33-0aff-4bea-8b97-7d7ee6499fca
        content: Which of the following information is stored by both the type of event queue objects?
        answerKeys:
          - A
          - B
          - D
        type: MultipleChoice
        choices:
          - content: Slot number
            key: A
          - content: Order ID
            key: B
          - content: Private key of the OpenOrders account
            key: C
          - content: Public key of the OpenOrders account
            key: D

      - uuid: bed11fe7-d2f3-4c15-bb35-2f4ae8a9cebd
        content: What are the two types of event queue objects?
        answerKeys:
          - A
          - C
        type: MultipleChoice
        choices:
          - content: Fill
            key: A
          - content: Base
            key: B
          - content: Out
            key: C
          - content: Request
            key: D

  - uuid: 740108b1-a6a6-4480-9f68-4b593e03df36
    name: Trade Lifecycle - Consuming Events
    content: |
      ## 3. Consuming events:
        * Events are popped off of the Event Queue and processed. This usually results in OpenOrders account balances being updated as a result of the trade.
        ### Necessary steps required in successfully consuming events:
          - The next event in the Event Queue is considered. If its OpenOrders account public key is found (via binary search - hence the sorting requirement)
          in the account list submitted by the client as writable, then continue. Otherwise, abort.
          - That event is popped off the queue and processed.
            - Fill:
              * The OpenOrders account's total balances are decremented by the quantity paid
              * The OpenOrders account's total and free balances are incremented by the quantity received
              * The Market's total fees paid counter increments by the number of fees paid
            - Out:
              * The OpenOrders account's free balance increments by quantity unlocked
              * If the event's specified quantity still locked is zero, then remove the order from the OpenOrders account's account list.
              Note that this can happen in constant time because the slot number is provided in the event.
    stepItems: []
  - uuid: 7caadc64-8688-4f24-ac77-bac31865848f
    name: Evaluation
    content: |
    stepItems: 
      - uuid: 0f2d4abd-d1a2-442d-a118-57333137e801
        content: Which processes take place in Fill?
        answerKeys:
          - A
          - D
        type: MultipleChoice
        choices:
          - content: The OpenOrders account's total balances are decremented by the quantity paid
            key: A
          - content: The OpenOrders account's total balances are incremented by the quantity paid
            key: B
          - content: The OpenOrders account's free balance increments by quantity unlocked
            key: C
          - content: The OpenOrders account's total and free balances are incremented by the quantity received
            key: D

      - uuid: db66938d-393c-4db7-91eb-3e60cc132a41
        content: Which of the following searching algorithms is used to find OpenOrders account public key?
        answerKeys:
          - B
        type: SingleChoice
        choices:
          - content: Linear Search
            key: A
          - content: Binary Search
            key: B
          - content: Interpolation Search
            key: C
          - content: Exponential Search
            key: D
  - uuid: 19a2d5a0-fcf2-4ce8-9124-a916016805ca
    name: Trade Lifecycle - Settlement
    content: |
      ## 4. Settlement:
        * Users can settle free funds from their OpenOrders back to their SPL token account at any time.
        - Step required in the settlement:
          * The user passes their OpenOrders account and their SPL token accounts for the base and quotes currency,
          signs with the “owner” of all of them (the same key pair that signed for placing orders using these same accounts),
          and the runtime does the following:
            * Using a cross-program invocation to the SPL token program moves funds from the Base Currency Vault 
            and Quote Currency Vault to the provided SPL token accounts equal to the free balance amount in the OpenOrders for each currency.

      The whole trade-lifecycle, starting from Placing the order, all the way to settlement, just takes a second or two. 
    stepItems: []
  - uuid: a1183156-e45b-4ddf-b381-897274ec0cb5
    name: Evaluation
    content: |
    stepItems:
      - uuid: 44fedf57-680e-41ea-8aac-d022cfac6571
        content: Select the correct statement(s) about settlement?
        answerKeys:
          - B
        type: SingleChoice
        choices:
          - content: Users can not settle free funds from their OpenOrders back to their SPL token account at any time
            key: A
          - content: Users can settle free funds from their OpenOrders back to their SPL token account at any time
            key: B
          - content: Users can settle free funds from their OpenOrders back to the Base Currency Vault at any time
            key: C
          - content: Users can settle free funds from their OpenOrders back to the Quote Currency Vault at any time
            key: D
      - uuid: 9e505cdc-ab22-498d-a86c-50eebb5201eb
        content: What is the time taken by the whole trade-lifecycle?
        answerKeys:
          - C
        type: SingleChoice
        choices:
          - content: 1-2 minutes
            key: A
          - content: 1-2 hours
            key: B
          - content: 1-2 seconds
            key: C
          - content: 1-2 milliseconds
            key: D
  - uuid: 5d98e292-6811-4f03-b17d-3bf6ff50b1b4
    name: Your Info
    content: |
    stepItems:
       - uuid: 42f0589d-d4e4-4e2b-b0da-b7f25a2292c6
         label: Nick Name
         required: true
         type: PublicShortInput
       - uuid: aa74c55c-b00f-425f-ac08-c2da022cbbe0
         type: UserDiscordConnect


      

    
